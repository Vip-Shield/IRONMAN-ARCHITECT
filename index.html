<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#e10600">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <title>Ironman Architect 70.3 (J.A.R.V.I.S. Uplink)</title>
    <link rel="shortcut icon" type="imagex/png" href="./img/logo-iron-man.ico">

    <style>
        :root {
            --iron-red: #e10600;
            --iron-dark: #0f0f0f;
            --iron-panel: rgba(26, 26, 26, 0.95); 
            --iron-white: #ffffff;
            --iron-gray: #444;
            --iron-gold: #ffce00;
            --iron-green: #00ff88;
            --iron-blue: #00c3ff;
            --iron-purple: #9d00ff;
            /* VARI√ÅVEIS VITAIS DIN√ÇMICAS */
            --vital-main: #00c3ff;
            --vital-bg: rgba(0, 195, 255, 0.1);
            --vital-shadow: rgba(0, 195, 255, 0.3);
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--iron-dark);
            color: var(--iron-white);
            margin: 0; padding: 20px;
            min-height: 100vh;
            padding-bottom: 90px;
        }

        /* --- ANIMA√á√ÉO DE INICIALIZA√á√ÉO DO SISTEMA --- */
        #startup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10000; pointer-events: none;
        }
        .startup-panel {
            position: absolute; left: 0; width: 100%; height: 50%;
            background-color: #050505;
            transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
        }
        .startup-panel.top { top: 0; }
        .startup-panel.bottom { bottom: 0; }
        .startup-line {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 0; height: 2px;
            background: var(--iron-blue);
            box-shadow: 0 0 15px var(--iron-blue), 0 0 30px var(--iron-blue);
            z-index: 10001;
            transition: width 0.4s ease-out, opacity 0.3s ease-out;
        }
        .startup-screen-active .startup-line { width: 100%; }
        .startup-screen-open .startup-panel.top { transform: translateY(-100%); }
        .startup-screen-open .startup-panel.bottom { transform: translateY(100%); }
        .startup-screen-open .startup-line { opacity: 0; }

        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: url('./img/iron_man.jpg');
            background-size: cover; background-position: center;
            filter: blur(8px) brightness(0.4); transform: scale(1.1);
        }

        .container { max-width: 900px; margin: 0 auto; position: relative; z-index: 1; }

        /* HEADER & BRANDING */
        header { border-bottom: 2px solid var(--iron-gray); padding-bottom: 20px; margin-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        
        .brand-luxo { display: flex; align-items: center; border-left: 4px solid var(--iron-red); padding-left: 12px; }
        .luxo-col { display: flex; flex-direction: column; }
        .luxo-top { font-size: 0.75rem; color: #888; letter-spacing: 4px; text-transform: uppercase; font-weight: 400; margin-bottom: -2px; }
        .luxo-bottom { font-size: 1.8rem; color: var(--iron-white); font-weight: 300; text-transform: uppercase; letter-spacing: 1px; line-height: 1; }
        .luxo-bold { font-weight: 800; color: var(--iron-white); }

        /* CONTADOR CL√ÅSSICO COM EFEITO EM CHAMAS DIN√ÇMICAS */
        .countdown-box {
            background: rgba(0,0,0,0.6); border: 1px solid var(--iron-red);
            padding: 10px 20px; border-radius: 6px; text-align: center; margin-top: 15px;
            display: flex; justify-content: center; align-items: center; gap: 20px; font-family: 'Courier New', monospace;
            cursor: pointer; transition: 0.3s;
        }
        .countdown-box:hover { background: rgba(0,0,0,0.8); box-shadow: 0 0 15px rgba(225, 6, 0, 0.3); }

        .fire-numbers {
            font-size: 2.03rem;
            font-weight: 900;
            color: #fff;
            /* Vari√°veis de cor com fallback para o fogo cl√°ssico */
            --fire-c1: #ffea00;
            --fire-c2: #ff8000;
            --fire-c3: #f00;
            text-shadow: 
                0 -1px 4px #FFF, 
                0 -2px 10px var(--fire-c1), 
                0 -6px 20px var(--fire-c2), 
                0 -12px 30px var(--fire-c3);
            animation: burn 0.5s infinite alternate;
            padding-bottom: 5px; 
        }
        
        @keyframes burn {
            0% { 
                text-shadow: 0 -1px 4px #FFF, 0 -2px 10px var(--fire-c1), 0 -8px 20px var(--fire-c2), 0 -14px 35px var(--fire-c3); 
                transform: translateY(0); 
            }
            100% { 
                text-shadow: 0 -1px 4px #FFF, 0 -4px 12px var(--fire-c1), 0 -12px 25px var(--fire-c2), 0 -20px 45px var(--fire-c3); 
                transform: translateY(-1px); 
            }
        }

        .header-controls { display: flex; gap: 10px; align-items: center; }
        .phase-badge { background: var(--iron-red); padding: 5px 15px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; text-transform: uppercase; }

        .btn-gear-icon { background: transparent; border: none; color: var(--iron-white); cursor: pointer; padding: 5px; transition: transform 0.3s; }
        .btn-gear-icon:hover { transform: rotate(90deg); color: var(--iron-gold); }
        .btn-gear-icon svg { width: 24px; height: 24px; fill: currentColor; }

        /* MONITOR DE SA√öDE */
        .health-strip {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(10, 25, 35, 0.9); border: 1px solid var(--vital-shadow);
            border-left: 3px solid var(--vital-main); padding: 12px 15px; border-radius: 8px; margin-bottom: 25px;
            backdrop-filter: blur(10px); cursor: pointer; position: relative; overflow: hidden;
            transition: border-color 0.5s, box-shadow 0.5s;
        }
        .health-strip:hover { box-shadow: 0 0 15px var(--vital-bg); transform: translateY(-2px); }
        
        .arc-reactor-mini {
            width: 38px; height: 38px; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.9) 20%, var(--vital-main) 65%, transparent 80%);
            box-shadow: 0 0 10px var(--vital-main); animation: pulse-vital 3s infinite; flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center;
            color: rgba(0, 0, 0, 0.25); font-weight: 900; font-size: 0.85rem;
        }
        @keyframes pulse-vital { 0% { box-shadow: 0 0 5px var(--vital-main); opacity: 0.8; } 50% { box-shadow: 0 0 20px var(--vital-main); opacity: 1; } 100% { box-shadow: 0 0 5px var(--vital-main); opacity: 0.8; } }

        .health-info { margin-left: 15px; flex-grow: 1; }
        .health-title { font-size: 0.75rem; color: var(--vital-main); text-transform: uppercase; letter-spacing: 1px; transition: color 0.5s; }
        .health-main { font-weight: bold; font-size: 0.95rem; color: white; display:flex; align-items:center; gap:10px;}
        .health-metrics { display: flex; gap: 15px; text-align: center; }
        .h-metric { display: flex; flex-direction: column; align-items: center; }
        .h-val { font-size: 1rem; font-weight: bold; color: white; }
        .h-lbl { font-size: 0.65rem; color: #888; text-transform: uppercase; }

        /* ALERTA JARVIS DE OCIOSIDADE */
        #jarvis-idle-alert { display: none; background: rgba(255, 206, 0, 0.1); border-left: 4px solid var(--iron-gold); padding: 15px; border-radius: 5px; margin-bottom: 25px; backdrop-filter: blur(5px); animation: fadeInAlert 0.5s ease-out; }
        @keyframes fadeInAlert { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUTS E PAINEL RETR√ÅTIL */
        .input-section { background: var(--iron-panel); padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #333; backdrop-filter: blur(10px); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .log-header { cursor: pointer; user-select: none; padding-bottom: 5px; border-bottom: 1px solid transparent; transition: 0.3s; }
        .log-header:hover { opacity: 0.8; }
        .log-content-wrapper { max-height: 500px; overflow: hidden; transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out, margin-top 0.4s ease-in-out; opacity: 1; }
        .log-content-wrapper.collapsed { max-height: 0; opacity: 0; margin-top: -10px; pointer-events: none; }
        .icon-rotate { display: inline-block; font-size: 0.7rem; color: var(--iron-red); transition: transform 0.3s ease; }
        .icon-rotate.collapsed { transform: rotate(-90deg); color: #888; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-col { flex: 1; display: flex; flex-direction: column; }
        .input-col label { font-size: 0.7rem; color: #888; margin-bottom: 3px; text-transform: uppercase; }
        input[type="number"], input[type="text"], select { background: rgba(37, 37, 37, 0.8); border: 1px solid var(--iron-gray); color: white; padding: 12px; border-radius: 4px; width: 100%; box-sizing: border-box; }

        .rpe-container { margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 6px; }
        .rpe-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; }
        input[type="range"] { width: 100%; cursor: pointer; height: 6px; background: #444; border-radius: 3px; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--iron-white); border-radius: 50%; border: 2px solid var(--iron-red); }
        .rpe-value { font-weight: bold; color: var(--iron-gold); }

        .btn-main { background: var(--iron-red); color: white; border: none; padding: 12px 25px; border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; width: 100%; transition: 0.2s; }
        .btn-main:hover { background: #b30500; }

        .gpx-link { font-size: 0.75rem; color: var(--iron-blue); cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 5px; opacity: 0.7; transition: 0.3s; }
        .gpx-link:hover { opacity: 1; text-shadow: 0 0 5px var(--iron-blue); }

        /* DASHBOARD GRID */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background: var(--iron-panel); padding: 20px; border-radius: 8px; border: 1px solid #333; position: relative; overflow: hidden; backdrop-filter: blur(10px); }
        .card h3 { margin: 0; font-size: 0.8rem; color: #888; text-transform: uppercase; }
        .value-display { font-size: 2.2rem; font-weight: bold; margin: 10px 0; }
        .sub-value { font-size: 0.9rem; color: #666; }
        .progress-bg { background: #333; height: 6px; border-radius: 3px; margin-top: 15px; position: relative; overflow: hidden; }
        .progress-fill { background: var(--iron-red); height: 100%; width: 0%; transition: 1s; }
        .ghost-marker { position: absolute; top: 0; bottom: 0; width: 4px; background: rgba(255, 255, 255, 0.9); box-shadow: 0 0 8px rgba(255, 255, 255, 0.8); z-index: 5; transition: left 1s ease-in-out; border-radius: 2px; }
        .status-text { font-size: 0.75rem; display: block; margin-top: 8px; font-weight: bold; text-align: right; }
        .status-positive { color: var(--iron-green); }
        .status-negative { color: var(--iron-red); }

        /* FOOTER MENU */
        .footer-bar { margin-top: 40px; display: flex; justify-content: space-between; background: var(--iron-panel); padding: 10px 5px; border-radius: 8px; border-top: 2px solid var(--iron-red); gap: 5px; }
        .footer-btn { background: none; border: none; color: #888; font-size: 0.65rem; text-transform: uppercase; display: flex; flex-direction: column; align-items: center; cursor: pointer; gap: 5px; flex: 1; }
        .footer-btn svg { width: 22px; height: 22px; fill: currentColor; }
        .footer-btn:hover, .footer-btn.active { color: var(--iron-white); }
        .footer-btn:hover svg { fill: var(--iron-red); }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1a1a1a; padding: 30px; border-radius: 8px; border: 1px solid var(--iron-gray); max-width: 600px; width: 90%; box-shadow: 0 0 30px rgba(0,0,0, 0.8); position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 15px; right: 20px; color: #888; cursor: pointer; font-size: 1.5rem; }
        
        #toast-container { position: fixed; bottom: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: rgba(10, 10, 10, 0.95); color: white; padding: 15px 20px; border-radius: 8px; border: 1px solid var(--iron-gray); box-shadow: 0 0 20px rgba(0,0,0,0.8); font-size: 0.9rem; transition: opacity 0.3s ease; backdrop-filter: blur(10px); min-width: 250px; }
        .log-item { background: rgba(37,37,37,0.6); padding: 15px; border-radius: 6px; border-left: 3px solid var(--iron-blue); margin-bottom: 10px; }
        .log-date { font-size: 0.75rem; color: #888; display: flex; justify-content: space-between; }
        .log-details { font-size: 0.95rem; color: var(--iron-white); margin-top: 5px; line-height: 1.4; }

        .level-tabs { display: flex; gap: 5px; margin-bottom: 20px; background: #222; padding: 5px; border-radius: 5px; }
        .level-tab { flex: 1; border: none; background: transparent; color: #888; padding: 10px 5px; cursor: pointer; font-size: 0.75rem; border-radius: 4px; transition: 0.3s; }
        .level-tab.active { background: #444; color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .level-tab.active.lvl-1 { border-bottom: 3px solid var(--iron-green); color: var(--iron-green); }
        .level-tab.active.lvl-2 { border-bottom: 3px solid var(--iron-gold); color: var(--iron-gold); }
        .level-tab.active.lvl-3 { border-bottom: 3px solid var(--iron-purple); color: var(--iron-purple); }
        .game-stat-row { margin-bottom: 25px; }
        .game-stat-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .game-bar-bg { width: 100%; height: 12px; background: #333; border-radius: 6px; overflow: hidden; position: relative; }
        .game-bar-fill { height: 100%; width: 0%; transition: width 1s ease-in-out; }
        .game-target-text { font-size: 0.75rem; color: #666; margin-top: 3px; text-align: right; }
        .level-badge { text-align: center; padding: 10px; margin-bottom: 20px; border: 1px solid #333; border-radius: 5px; background: rgba(0,0,0,0.3); }
        .level-badge h3 { margin: 0; font-size: 1.2rem; }
        .level-badge p { margin: 5px 0 0; color: #aaa; font-size: 0.85rem; font-style: italic; }
        .gear-item { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #333; }
        .gear-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .gear-reset { background: #333; border: 1px solid #555; color: #ccc; font-size: 0.7rem; padding: 3px 8px; cursor: pointer; border-radius: 4px; }
        .nutrition-result { background: #222; padding: 15px; border-left: 3px solid var(--iron-gold); margin-top: 20px; display: none; }
        .compare-toggle { display: flex; gap: 10px; margin-bottom: 20px; }
        .toggle-btn { flex: 1; padding: 10px; border: 1px solid var(--iron-gray); background: transparent; color: #888; cursor: pointer; }
        .toggle-btn.active { background: var(--iron-red); color: white; border-color: var(--iron-red); }
        .compare-row { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .compare-inputs { display: flex; gap: 5px; align-items: center; margin-top: 5px; }
        .tiny-input { width: 60px; padding: 8px; background: #222; border: 1px solid #444; color: white; border-radius: 4px; }
        .compare-bar-container { height: 10px; background: #333; border-radius: 5px; margin-top: 10px; position: relative; }
        .compare-bar-fill { height: 100%; background: var(--iron-gold); width: 0%; border-radius: 5px; transition: 1s; }
        .compare-label { font-size: 0.75rem; color: #888; display: flex; justify-content: space-between; margin-top: 3px; }
        .tips-box { background: rgba(255, 206, 0, 0.1); padding: 15px; border-radius: 5px; margin-top: 10px; border-left: 2px solid var(--iron-gold); }
        .tips-box h4 { margin: 0 0 5px 0; color: var(--iron-gold); font-size: 0.9rem; }
        .tips-box p { font-size: 0.85rem; color: #ccc; margin: 0; line-height: 1.4; }
        .plan-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        @media(min-width: 600px) { .plan-grid { grid-template-columns: 1fr 1fr; } }
        .plan-item { background: rgba(37, 37, 37, 0.8); padding: 15px; border-radius: 5px; border-left: 3px solid var(--iron-red); }
        .plan-item h4 { margin: 0 0 5px 0; color: var(--iron-red); text-transform: uppercase; font-size: 0.85rem; }
        .plan-item p { margin: 0; font-size: 0.9rem; color: #ddd; line-height: 1.4; white-space: pre-line; }
        .full-width { grid-column: 1 / -1; border-left: 3px solid var(--iron-gold); }
        .btn-file-input { display: none; }
        .backup-row { display: flex; gap: 10px; margin-top: 20px; }
        .report-table { width: 100%; border-collapse: collapse; }
        .report-table td, .report-table th { padding: 8px; border-bottom: 1px solid #333; text-align: left; }
    </style>
</head>
<body>

<div id="startup-screen">
    <div class="startup-panel top"></div>
    <div class="startup-panel bottom"></div>
    <div class="startup-line"></div>
</div>

<div id="toast-container"></div> <div class="bg-overlay"></div>

<div class="container">
    <header>
        <div class="header-top">
            <div class="brand-luxo">
                <div class="luxo-col">
                    <span class="luxo-top">PROJECT</span>
                    <span class="luxo-bottom">IRON<span class="luxo-bold">MAN</span></span>
                </div>
            </div>
            
            <div class="header-controls">
                <button class="btn-gear-icon" onclick="openModal('settingsModal')" aria-label="Configura√ß√µes">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.43-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
                </button>
                <div class="phase-badge" id="phase-badge">Fase 1</div>
            </div>
        </div>

        <div class="countdown-box" id="countdown-display" onclick="openModal('settingsModal')">
            <span style="font-size:0.9rem; color:#888; align-self:center;">Toque na Engrenagem para definir a data da prova</span>
        </div>
    </header>

    <div class="health-strip" onclick="openModal('healthModal')">
        <div style="display:flex; align-items:center;">
            <div class="arc-reactor-mini" id="display-health-age"></div>
            <div class="health-info">
                <div class="health-title" id="display-health-name">Sinais Vitais</div>
                <div class="health-main">
                    <span id="display-bmi-status">Normal</span>
                    <span style="font-size:0.7rem; color:#666; font-weight:normal; margin-left:5px;">(Toque para editar)</span>
                </div>
            </div>
        </div>
        <div class="health-metrics">
            <div class="h-metric">
                <span class="h-val" id="val-weight">--</span>
                <span class="h-lbl">KG</span>
            </div>
            <div class="h-metric">
                <span class="h-val" id="val-fat">--</span>
                <span class="h-lbl">% GORD</span>
            </div>
        </div>
    </div>

    <div id="jarvis-idle-alert">
        <div style="display:flex; align-items:center; gap: 15px;">
            <span style="font-size: 1.8rem;">‚ö†Ô∏è</span>
            <div>
                <h4 style="margin:0; font-size:0.9rem;">J.A.R.V.I.S. // AVISO DE PROTOCOLO</h4>
                <p id="jarvis-idle-msg" style="margin: 5px 0 0 0; font-size: 0.85rem; color: #ccc;"></p>
            </div>
        </div>
    </div>

    <div class="input-section">
        <div class="log-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;" onclick="toggleLog()">
            <div style="display: flex; align-items: center; gap: 8px;">
                <h3 style="margin:0; color: #ccc;">Log de Treino</h3>
                <span id="log-icon" class="icon-rotate collapsed">‚ñº</span>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center;">
                <span class="gpx-link" onclick="event.stopPropagation(); syncStrava()" style="color: #fc4c02;" title="Sincronizar √∫ltima atividade do Strava">
                    <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:currentColor;"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
                    Strava API
                </span>
                <label class="gpx-link" onclick="event.stopPropagation();">
                    <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:currentColor;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13.5,16V19H10.5V16H8L12,12L16,16H13.5M13,9V3.5L18.5,9H13Z"/></svg>
                    Importar GPX
                    <input type="file" id="gpx-input" accept=".gpx" class="btn-file-input" onchange="handleGPXUpload(this)">
                </label>
            </div>
        </div>
        
        <div id="log-inputs-wrapper" class="log-content-wrapper collapsed">
            <div class="input-row">
                <div class="input-col"><label>üèä Nata√ß√£o (m)</label><input type="number" id="in-swim" placeholder="Metros"></div>
                <div class="input-col"><label>Tempo (min)</label><input type="number" id="in-swim-time" placeholder="Minutos"></div>
            </div>
            <div class="input-row">
                <div class="input-col"><label>üö¥ Ciclismo (km)</label><input type="number" id="in-bike" placeholder="Km"></div>
                <div class="input-col"><label>Tempo (min)</label><input type="number" id="in-bike-time" placeholder="Minutos"></div>
            </div>
            <div class="input-row">
                <div class="input-col"><label>üèÉ Corrida (km)</label><input type="number" id="in-run" placeholder="Km"></div>
                <div class="input-col"><label>Tempo (min)</label><input type="number" id="in-run-time" placeholder="Minutos"></div>
            </div>
        </div>

        <div class="rpe-container">
            <div class="rpe-header">
                <span>Intensidade (RPE)</span><span id="rpe-text" class="rpe-value">Moderado (5)</span>
            </div>
            <input type="range" id="rpe-input" min="1" max="10" value="5" oninput="updateRPEText(this.value)">
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="btn-main" onclick="openLogsModal()" style="background:var(--iron-gray); flex: 0.4; font-size: 0.8rem;">Hist√≥rico</button>
            <button class="btn-main" onclick="addTraining()" style="flex: 1;">Salvar Treino</button>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h3>Nata√ß√£o</h3>
            <div class="value-display"><span id="val-swim">0</span> <small>m</small></div>
            <div class="sub-value">Meta: <span id="goal-swim">0</span>m</div>
            <div class="progress-bg">
                <div id="bar-swim" class="progress-fill"></div>
                <div id="ghost-swim" class="ghost-marker" style="left: 0%;"></div>
            </div>
            <span id="status-swim" class="status-text"></span>
        </div>
        <div class="card">
            <h3>Bike</h3>
            <div class="value-display"><span id="val-bike">0</span> <small>km</small></div>
            <div class="sub-value">Meta: <span id="goal-bike">0</span>km</div>
            <div class="progress-bg">
                <div id="bar-bike" class="progress-fill"></div>
                <div id="ghost-bike" class="ghost-marker" style="left: 0%;"></div>
            </div>
            <span id="status-bike" class="status-text"></span>
        </div>
        <div class="card">
            <h3>Corrida</h3>
            <div class="value-display"><span id="val-run">0</span> <small>km</small></div>
            <div class="sub-value">Meta: <span id="goal-run">0</span>km</div>
            <div class="progress-bg">
                <div id="bar-run" class="progress-fill"></div>
                <div id="ghost-run" class="ghost-marker" style="left: 0%;"></div>
            </div>
            <span id="status-run" class="status-text"></span>
        </div>
    </div>

    <div class="footer-bar">
        <button class="footer-btn" onclick="openModal('planModal')"><svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M16,13H8V11H16V13M16,17H8V15H16V17M13,9V3.5L18.5,9H13Z"/></svg>Plano</button>
        <button class="footer-btn" onclick="openModal('volumeModal')"><svg viewBox="0 0 24 24"><path d="M9.68,13.61C9.96,13.21 10.78,13.21 11.06,13.61L12,15L12,15L12,15C12.16,15.24 12.39,15.5 12.76,15.5H16.24C16.63,15.5 16.85,15.24 17.03,15L18.66,12.55C18.94,12.15 19.76,12.15 20.04,12.55L22,15.5V19C22,20.11 21.11,21 20,21H4C2.9,21 2,20.11 2,19V17L9.68,13.61M21,7H3V5H21V7M21,11H8V9H21V11Z"/></svg>Metas</button>
        <button class="footer-btn" onclick="openModal('nutritionModal')"><svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M13,17H11V11H13V17M13,9H11V7H13V9Z"/></svg>Nutri</button>
        <button class="footer-btn" onclick="openModal('compareModal')"><svg viewBox="0 0 24 24"><path d="M16,6L18.29,8.29L13.41,13.17L9.41,9.17L2,16.59L3.41,18L9.41,12L13.41,16L19.71,9.71L22,12V6H16Z"/></svg>Check</button>
        <button class="footer-btn" onclick="openModal('gearModal')"><svg viewBox="0 0 24 24"><path d="M12,16A3,3 0 0,1 9,13C9,11.88 9.61,10.9 10.5,10.39L20.21,4.77L14.68,14.35C14.18,15.33 13.17,16 12,16M12,3C13.81,3 15.5,3.5 16.97,4.32L14.87,5.53C14,5.19 13,5 12,5A8,8 0 0,0 4,13C4,15.21 4.89,17.21 6.34,18.65H6.35C6.74,19.04 6.74,19.67 6.35,20.06C5.96,20.45 5.32,20.45 4.93,20.07V20.07C3.12,18.26 2,15.76 2,13A10,10 0 0,1 12,3M22,13C22,15.76 20.88,18.26 19.07,20.07V20.07C18.68,20.45 18.05,20.45 17.66,20.06C17.27,19.67 17.27,19.04 17.66,18.65V18.65C19.11,17.2 20,15.21 20,13C20,12 19.81,11 19.46,10.1L20.67,8C21.5,9.5 22,11.18 22,13Z"/></svg>Equip</button>
        <button class="footer-btn" onclick="generateReport()"><svg viewBox="0 0 24 24"><path d="M3.5,18.5L9.5,12.5L13.5,16.5L22,6.92L20.59,5.5L13.5,13.5L9.5,9.5L2,17L3.5,18.5Z"/></svg>Status</button>
    </div>
</div>

<div class="modal-overlay" id="logsModal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('logsModal')">&times;</span>
        <h2 style="color:var(--iron-blue); margin-top:0;">Hist√≥rico de Uplink</h2>
        <p style="color:#ccc; font-size:0.9rem;">As suas √∫ltimas 10 sess√µes (Pace auto-calculado).</p>
        <div id="logs-container" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
            </div>
    </div>
</div>

<div class="modal-overlay" id="healthModal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('healthModal')">&times;</span>
        <h2 style="color:var(--vital-main);">Monitor Fisiol√≥gico <span id="health-icon">üîµ</span></h2>
        <p style="color:#ccc; font-size:0.9rem;">Configure a sua biometria base.</p>
        
        <div class="input-group" style="display:flex; gap:10px; flex-wrap:wrap;">
            <div style="flex:2;"><label style="color:#888; font-size:0.8rem;">Atleta</label><input type="text" id="health-name" placeholder="O seu Nome"></div>
            <div style="flex:1;"><label style="color:#888; font-size:0.8rem;">Sexo</label>
                <select id="health-sex" style="width:100%; padding:12px; background:rgba(37,37,37,0.8); color:white; border:1px solid var(--iron-gray); border-radius:4px;">
                    <option value="M">Masculino</option>
                    <option value="F">Feminino</option>
                </select>
            </div>
        </div>
        <div class="input-row">
            <div class="input-col"><label>Peso (kg)</label><input type="number" id="health-weight"></div>
            <div class="input-col"><label>Altura (cm)</label><input type="number" id="health-height"></div>
        </div>
        <div class="input-row">
             <div class="input-col"><label>% Gordura (Vazio = Auto)</label><input type="number" step="0.1" id="health-fat" placeholder="Auto"></div>
            <div class="input-col"><label>Idade</label><input type="number" id="health-age"></div>
        </div>
        <hr style="border:1px solid #333; margin:20px 0;">
        <div style="background:var(--vital-bg); padding:15px; border-radius:5px; border-left:3px solid var(--vital-main); margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span style="color:var(--vital-main);">IMC Calculado:</span><span id="calc-imc" style="font-weight:bold; color:white;">--</span></div>
            <div style="display:flex; justify-content:space-between;"><span style="color:var(--vital-main);">Queima Basal (TMB):</span><span id="calc-bmr" style="font-weight:bold; color:white;">-- kcal/dia</span></div>
            <p style="font-size:0.75rem; color:#888; margin:10px 0 0 0;">*TMB e Gordura ajustadas via algoritmo Deurenberg e Harris-Benedict.</p>
        </div>
        <button class="btn-main" style="background:var(--vital-main);" onclick="saveHealthData()">Atualizar Sinais Vitais</button>
    </div>
</div>

<div class="modal-overlay" id="volumeModal"><div class="modal-content"><span class="close-btn" onclick="closeModal('volumeModal')">&times;</span><h2 style="margin-top:0;">Desafio Anual üèÜ</h2><div class="level-tabs"><button class="level-tab active lvl-1" onclick="setVolumeLevel(1)">INICIANTE</button><button class="level-tab lvl-2" onclick="setVolumeLevel(2)">AMADOR</button><button class="level-tab lvl-3" onclick="setVolumeLevel(3)">PRO ELITE</button></div><div class="level-badge" id="lvl-badge"></div><div class="game-stat-row"><div class="game-stat-header"><span style="color:var(--iron-blue);">Nata√ß√£o (m)</span><span><span id="game-swim-curr">0</span> / <span id="game-swim-target">0</span></span></div><div class="game-bar-bg"><div id="game-bar-swim" class="game-bar-fill" style="background:var(--iron-blue);"></div></div><div class="game-target-text" id="game-swim-pct">0% Conclu√≠do</div></div><div class="game-stat-row"><div class="game-stat-header"><span style="color:var(--iron-red);">Ciclismo (km)</span><span><span id="game-bike-curr">0</span> / <span id="game-bike-target">0</span></span></div><div class="game-bar-bg"><div id="game-bar-bike" class="game-bar-fill" style="background:var(--iron-red);"></div></div><div class="game-target-text" id="game-bike-pct">0% Conclu√≠do</div></div><div class="game-stat-row"><div class="game-stat-header"><span style="color:var(--iron-green);">Corrida (km)</span><span><span id="game-run-curr">0</span> / <span id="game-run-target">0</span></span></div><div class="game-bar-bg"><div id="game-bar-run" class="game-bar-fill" style="background:var(--iron-green);"></div></div><div class="game-target-text" id="game-run-pct">0% Conclu√≠do</div></div></div></div>
<div class="modal-overlay" id="nutritionModal"><div class="modal-content"><span class="close-btn" onclick="closeModal('nutritionModal')">&times;</span><h2 style="color:var(--iron-gold);">Laborat√≥rio de Combust√≠vel üçå</h2><div class="input-row"><div class="input-col"><input type="number" id="nutri-weight" placeholder="O seu Peso (kg)"></div><div class="input-col"><input type="number" id="nutri-hours" placeholder="Dura√ß√£o Treino (horas)"></div></div><button class="btn-main" onclick="calculateNutrition()">Calcular Necessidade</button><div id="nutri-result" class="nutrition-result"><h4 style="margin:0; color:var(--iron-white);">Voc√™ precisa de:</h4><div style="font-size:2rem; font-weight:bold; color:var(--iron-gold); margin:10px 0;" id="nutri-grams">0g Carbo</div><p style="margin:0; font-size:0.9rem; color:#ccc;">Isto equivale a:</p><ul id="nutri-breakdown" style="color:white; padding-left:20px; line-height:1.6;"></ul></div></div></div>
<div class="modal-overlay" id="compareModal"><div class="modal-content"><span class="close-btn" onclick="closeModal('compareModal')">&times;</span><h2 style="margin-top:0;">Reality Check üéØ</h2><div class="compare-toggle"><button class="toggle-btn active" id="btn-703" onclick="setCompareMode('70.3')">Ironman 70.3</button><button class="toggle-btn" id="btn-full" onclick="setCompareMode('Full')">Full Ironman</button></div><div class="compare-row"><label style="color:var(--iron-blue);">üèä Nata√ß√£o (Pace /100m)</label><div class="compare-inputs"><input type="number" id="comp-swim-min" class="tiny-input" placeholder="min"> :<input type="number" id="comp-swim-sec" class="tiny-input" placeholder="seg"></div><div class="compare-bar-container"><div id="comp-bar-swim" class="compare-bar-fill"></div></div><div class="compare-label"><span>O seu Pace: <strong id="pct-swim" style="color:var(--iron-white)">0%</strong></span><span id="target-swim">Alvo: 1:30/100m</span></div><div class="tips-box" id="tip-swim"></div></div><div class="compare-row"><label style="color:var(--iron-red);">üö¥ Ciclismo (M√©dia km/h)</label><div class="compare-inputs"><input type="number" id="comp-bike-kmh" class="tiny-input" placeholder="km/h" style="width:100px;"></div><div class="compare-bar-container"><div id="comp-bar-bike" class="compare-bar-fill"></div></div><div class="compare-label"><span>A sua M√©dia: <strong id="pct-bike" style="color:var(--iron-white)">0%</strong></span><span id="target-bike">Alvo: 40 km/h</span></div><div class="tips-box" id="tip-bike"></div></div><div class="compare-row" style="border:none;"><label style="color:var(--iron-green);">üèÉ Corrida (Pace min/km)</label><div class="compare-inputs"><input type="number" id="comp-run-min" class="tiny-input" placeholder="min"> :<input type="number" id="comp-run-sec" class="tiny-input" placeholder="seg"></div><div class="compare-bar-container"><div id="comp-bar-run" class="compare-bar-fill"></div></div><div class="compare-label"><span>O seu Pace: <strong id="pct-run" style="color:var(--iron-white)">0%</strong></span><span id="target-run">Alvo: 3:45/km</span></div><div class="tips-box" id="tip-run"></div></div><button class="btn-main" onclick="comparePerformance()">Analisar Performance</button></div></div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('settingsModal')">&times;</span>
        <h2 style="margin-top:0;">Configura√ß√µes</h2>
        <label style="color:#888;">üìÖ Data da Prova (1 Ano Sugerido):</label>
        <input type="date" id="race-date-input" class="settings-input" onchange="saveRaceDate()" style="width:100%; padding:10px; margin:10px 0; background:#333; color:white; border:1px solid #555;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin: 20px 0; background:rgba(0,0,0,0.3); padding:10px; border-radius:5px;">
            <span style="color:#ccc; font-size:0.9rem;">üó£Ô∏è Voz (J.A.R.V.I.S)</span>
            <button id="btn-voice-toggle" class="btn-main" style="width:auto; padding:5px 15px; font-size:0.75rem;" onclick="toggleVoice()">LIGADO</button>
        </div>

        <hr style="border:1px solid #333; margin:20px 0;">
        <h3 style="font-size:1rem; color:var(--iron-blue);">üíæ Backup de Seguran√ßa</h3>
        <div class="backup-row">
            <button class="btn-main" style="background:var(--iron-blue);" onclick="exportData()">‚¨á Salvar</button>
            <label class="btn-main" style="background:var(--iron-gray); text-align:center; cursor:pointer;">‚¨Ü Restaurar<input type="file" class="btn-file-input" id="backup-file" onchange="importData(this)"></label>
        </div>
        
        <hr style="border:1px solid #333; margin:20px 0;">
        <h3 style="font-size:1rem; color:var(--iron-purple);">‚è±Ô∏è J.A.R.V.I.S. Override (Debug de Tempo)</h3>
        <p style="font-size:0.8rem; color:#888;">Simule o avan√ßo do tempo para testar as Fases e Cores do Fogo.</p>
        <div style="display:flex; gap:10px; margin-bottom: 20px;">
            <button class="btn-main" style="background:var(--iron-purple); font-size: 0.8rem;" onclick="simulateTimeTravel(7)">+ 1 Semana</button>
            <button class="btn-main" style="background:var(--iron-purple); font-size: 0.8rem;" onclick="simulateTimeTravel(30)">+ 1 M√™s</button>
            <button class="btn-main" style="background:#555; font-size: 0.8rem;" onclick="resetTimeTravel()">Reset</button>
        </div>

        <hr style="border:1px solid #333; margin:20px 0;">
        <h3 style="font-size:1rem; color:var(--iron-red);">‚ö† Zona de Perigo</h3>
        <button class="btn-main" style="background:#333; border:1px solid var(--iron-red); color:var(--iron-red);" onclick="factoryReset()">‚ò¢Ô∏è APAGAR TUDO</button>
    </div>
</div>

<div class="modal-overlay" id="gearModal"><div class="modal-content"><span class="close-btn" onclick="closeModal('gearModal')">&times;</span><h2 style="color:var(--iron-red);">Garagem üîß</h2><div class="gear-item"><div class="gear-header"><span>üëü T√©nis</span><button class="gear-reset" onclick="resetGear('shoes')">Trocar</button></div><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span id="gear-shoes-val">0 km</span><span style="font-size:0.8rem; color:#666;">Limite: 800km</span></div><div class="progress-bg"><div id="bar-shoes" class="progress-fill"></div></div><p id="alert-shoes" style="font-size:0.8rem; color:var(--iron-red); display:none; margin-top:5px;">‚ö† LIMITE ATINGIDO!</p></div><div class="gear-item" style="border:none;"><div class="gear-header"><span>‚õìÔ∏è Corrente</span><button class="gear-reset" onclick="resetGear('chain')">Trocar</button></div><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span id="gear-chain-val">0 km</span><span style="font-size:0.8rem; color:#666;">Limite: 5000km</span></div><div class="progress-bg"><div id="bar-chain" class="progress-fill"></div></div></div></div></div>
<div class="modal-overlay" id="planModal"><div class="modal-content"><span class="close-btn" onclick="closeModal('planModal')">&times;</span><h2 style="margin-top:0;">Plano T√°tico</h2><p id="plan-phase-name" style="color:var(--iron-red); font-weight:bold;"></p><p id="plan-objective" style="color:var(--iron-gold); font-style:italic; margin-bottom:20px;"></p><div class="plan-grid" id="plan-container"></div></div></div>
<div class="modal-overlay" id="reportModal"><div class="modal-content"><span class="close-btn" onclick="closeModal('reportModal')">&times;</span><h2 style="color:var(--iron-red);">Relat√≥rio de Cruzamento</h2><table class="report-table"><tbody id="report-body"></tbody></table><div id="verdict-display" class="verdict" style="text-align:center; font-weight:bold; margin-top:20px;"></div><button class="btn-main" id="btn-advance" onclick="advancePhase()" style="display:none; margin-top:15px;">Avan√ßar Fase</button></div></div>

<script>
    // --- STRAVA API INTEGRATION ---
    const STRAVA_CLIENT_ID = 'SEU_CLIENT_ID';
    const STRAVA_CLIENT_SECRET = 'SEU_CLIENT_SECRET';
    const STRAVA_REFRESH_TOKEN = 'SEU_REFRESH_TOKEN';

    async function syncStrava() {
        if (STRAVA_CLIENT_ID === 'SEU_CLIENT_ID') {
            showToast("Configure as credenciais do Strava no c√≥digo fonte.", "var(--iron-gold)");
            jarvisSpeak("Senhor, as credenciais da API do Strava n√£o est√£o configuradas.");
            return;
        }
        try {
            showToast("Conectando aos sat√©lites Strava...", "var(--iron-blue)");
            const tokenResponse = await fetch(`https://www.strava.com/oauth/token`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ client_id: STRAVA_CLIENT_ID, client_secret: STRAVA_CLIENT_SECRET, refresh_token: STRAVA_REFRESH_TOKEN, grant_type: 'refresh_token' }) });
            const tokenData = await tokenResponse.json(); const accessToken = tokenData.access_token;
            if(!accessToken) throw new Error("Falha na autentica√ß√£o do Strava.");
            const activitiesResponse = await fetch(`https://www.strava.com/api/v3/athlete/activities?per_page=1`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
            const activities = await activitiesResponse.json();
            if (activities && activities.length > 0) processStravaActivity(activities[0]);
            else { showToast("Nenhuma atividade recente encontrada no Strava.", "var(--iron-gold)"); jarvisSpeak("N√£o localizei nenhuma telemetria recente nos servidores do Strava, senhor."); }
        } catch (error) { console.error("Erro Strava API:", error); showToast("Falha na comunica√ß√£o com o Strava.", "var(--iron-red)"); }
    }

    function processStravaActivity(activity) {
        const distanceKm = (activity.distance / 1000).toFixed(2), distanceM = activity.distance.toFixed(0), timeMin = Math.round(activity.moving_time / 60);
        document.getElementById('in-swim').value = ""; document.getElementById('in-swim-time').value = ""; document.getElementById('in-bike').value = ""; document.getElementById('in-bike-time').value = ""; document.getElementById('in-run').value = ""; document.getElementById('in-run-time').value = "";
        let sportName = "";
        if (activity.type === 'Ride' || activity.type === 'VirtualRide') { document.getElementById('in-bike').value = distanceKm; document.getElementById('in-bike-time').value = timeMin; sportName = "Ciclismo"; } 
        else if (activity.type === 'Run' || activity.type === 'VirtualRun') { document.getElementById('in-run').value = distanceKm; document.getElementById('in-run-time').value = timeMin; sportName = "Corrida"; } 
        else if (activity.type === 'Swim') { document.getElementById('in-swim').value = distanceM; document.getElementById('in-swim-time').value = timeMin; sportName = "Nata√ß√£o"; } 
        else { showToast(`Esporte n√£o suportado: ${activity.type}`, "var(--iron-gold)"); return; }

        showToast(`Dados de ${sportName} importados do Strava! Salve o treino.`, "var(--iron-blue)"); jarvisSpeak(`Download de telemetria conclu√≠do. Atividade de ${sportName} detetada e carregada no painel, senhor.`);
        const wrapper = document.getElementById('log-inputs-wrapper'); const icon = document.getElementById('log-icon');
        if (wrapper.classList.contains('collapsed')) { wrapper.classList.remove('collapsed'); icon.classList.remove('collapsed'); }
    }

    // --- GERADOR DE SOM (WEB AUDIO API) ---
    function playBootSound() {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext; if (!AudioContext) return;
            const ctx = new AudioContext(), osc = ctx.createOscillator(), gain = ctx.createGain();
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(50, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.6);
            gain.gain.setValueAtTime(0, ctx.currentTime); gain.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.1); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
            osc.connect(gain); gain.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 1);
        } catch(e) {}
    }

    window.addEventListener('load', () => {
        const startupScreen = document.getElementById('startup-screen'); playBootSound();
        setTimeout(() => { startupScreen.classList.add('startup-screen-active'); }, 200); setTimeout(() => { startupScreen.classList.add('startup-screen-open'); }, 800); setTimeout(() => { startupScreen.remove(); }, 1800);
    });

    const phasesConfig = [
        { id: 1, name: "Fase 1: Constru√ß√£o da Base (Meses 1-3)", goals: { swim: 24000, bike: 600, run: 120 }, plan: { obj: "Sair do zero sem les√µes.", swim: "2x semana\nFoco: Aprender a respirar.", bike: "1-2x semana (40-60min)\nLeve.", run: "2-3x semana (30min)\nCaminhada -> Trote.", gym: "2x semana\nObrigat√≥rio." } },
        { id: 2, name: "Fase 2: Resist√™ncia Real (Meses 4-6)", goals: { swim: 36000, bike: 1200, run: 300 }, plan: { obj: "Come√ßa a ficar s√©rio.", swim: "1.500‚Äì2.000 m/sess√£o.", bike: "60‚Äì90 min.", run: "5‚Äì8 km confort√°veis.", gym: "1 treino combinado." } },
        { id: 3, name: "Fase 3: Volume Espec√≠fico (Meses 7-9)", goals: { swim: 45000, bike: 2000, run: 450 }, plan: { obj: "Ironman de verdade.", swim: "2.500‚Äì3.000 m.", bike: "Long√£o: 2h30‚Äì4h.", run: "Long√£o: 12‚Äì18 km.", gym: "Treino 'brick'." } },
        { id: 4, name: "Fase 4: Simula√ß√£o e Polimento (Meses 10-12)", goals: { swim: 15000, bike: 400, run: 80 }, plan: { obj: "Taper.", swim: "3.000‚Äì3.800 m.", bike: "Simula√ß√£o 5h.", run: "Simula√ß√£o 25‚Äì30 km.", gym: "Reduzir volume." } }
    ];

    const annualTargets = {
        1: { name: "Finisher (Iniciante)", desc: "Meta: Cruzar a linha.", color: "var(--iron-green)", swim: 150000, bike: 3500, run: 900 },
        2: { name: "Iron Amateur (Competitivo)", desc: "Ref: Age Grouper.", color: "var(--iron-gold)", swim: 300000, bike: 8000, run: 1800 },
        3: { name: "Kona Elite (Pro)", desc: "Ref: Profissional.", color: "var(--iron-purple)", swim: 900000, bike: 20000, run: 3500 }
    };

    let appState = JSON.parse(localStorage.getItem('ironmanState')) || {};
    
    if(appState.phaseIndex === undefined) appState.phaseIndex = 0; if(!appState.data) appState.data = { swim: 0, bike: 0, run: 0 };
    if(!appState.totalAccumulated) appState.totalAccumulated = { swim: 0, bike: 0, run: 0 }; if(!appState.gear) appState.gear = { shoes:0, chain:0 };
    if(!appState.health) appState.health = { name: "Rodrigo", sex: "M", weight: 105, height: 190, fat: 0, age: 43 };
    if(!appState.health.name) appState.health.name = "Rodrigo"; if(!appState.health.sex) appState.health.sex = "M";
    if(!appState.phaseStartDate) appState.phaseStartDate = new Date().toISOString(); if(!appState.logs) appState.logs = [];
    if(appState.settings === undefined) appState.settings = { voice: true };
    
    let currentCompareMode = '70.3', currentVolumeLevel = 1;

    function init() {
        updateUI(); startCountdown(); updateGearUI(); updateHealthUI();
        if(appState.raceDate) document.getElementById('race-date-input').value = appState.raceDate;
        document.getElementById('btn-voice-toggle').innerText = appState.settings.voice ? "LIGADO" : "DESLIGADO";
        document.getElementById('btn-voice-toggle').style.background = appState.settings.voice ? "var(--iron-green)" : "#444";
        renderTips();

        if(!sessionStorage.getItem('jarvisWelcomed')) {
            sessionStorage.setItem('jarvisWelcomed', 'true');
            let referenceDate = new Date(appState.phaseStartDate);
            if(appState.logs && appState.logs.length > 0) referenceDate = new Date(appState.logs[0].date);
            const diffDays = Math.floor((new Date() - referenceDate) / (1000 * 60 * 60 * 24));
            
            if(diffDays >= 7) setTimeout(() => jarvisSpeak(`Aten√ß√£o, alerta cr√≠tico senhor. Sem treinos registados h√° ${diffDays} dias. O condicionamento est√° em risco.`), 2500);
            else if(diffDays >= 3) setTimeout(() => jarvisSpeak(`Aviso, senhor. J√° se passaram ${diffDays} dias desde o √∫ltimo treino.`), 2500);
            else setTimeout(() => jarvisSpeak("Sistemas online. Bem-vindo de volta, senhor."), 2500);
        }
    }

    function showToast(message, color="var(--iron-green)") {
        const container = document.getElementById('toast-container'), toast = document.createElement('div');
        toast.className = 'toast'; toast.style.borderLeft = `4px solid ${color}`; toast.innerHTML = message;
        container.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
    }
    function jarvisSpeak(text) {
        if(!appState.settings.voice || !window.speechSynthesis) return;
        const synth = window.speechSynthesis; if(synth.speaking) synth.cancel();
        const ut = new SpeechSynthesisUtterance(text); ut.lang = 'pt-BR'; ut.rate = 1.0; ut.pitch = 0.9; synth.speak(ut);
    }
    function toggleVoice() {
        appState.settings.voice = !appState.settings.voice; saveState();
        document.getElementById('btn-voice-toggle').innerText = appState.settings.voice ? "LIGADO" : "DESLIGADO"; document.getElementById('btn-voice-toggle').style.background = appState.settings.voice ? "var(--iron-green)" : "#444";
        if(appState.settings.voice) jarvisSpeak("Sistemas de voz online, senhor.");
    }
    function toggleLog() { const wrapper = document.getElementById('log-inputs-wrapper'); const icon = document.getElementById('log-icon'); wrapper.classList.toggle('collapsed'); icon.classList.toggle('collapsed'); }

    function checkIdleAlert() {
        const alertBox = document.getElementById('jarvis-idle-alert'), msgBox = document.getElementById('jarvis-idle-msg'), headerText = document.querySelector('#jarvis-idle-alert h4');
        let referenceDate = new Date(appState.phaseStartDate);
        if(appState.logs && appState.logs.length > 0) referenceDate = new Date(appState.logs[0].date);
        const diffDays = Math.floor((new Date() - referenceDate) / (1000 * 60 * 60 * 24));

        if(diffDays >= 7) { alertBox.style.display = 'block'; alertBox.style.borderLeftColor = 'var(--iron-red)'; alertBox.style.background = 'rgba(225, 6, 0, 0.1)'; headerText.style.color = 'var(--iron-red)'; msgBox.innerHTML = `<strong style="color:var(--iron-red)">ALERTA CR√çTICO:</strong> Senhor, n√£o detecto atividade h√° ${diffDays} dias. O protocolo Ironman est√° em risco de degrada√ß√£o estrutural.`; } 
        else if(diffDays >= 3) { alertBox.style.display = 'block'; alertBox.style.borderLeftColor = 'var(--iron-gold)'; alertBox.style.background = 'rgba(255, 206, 0, 0.1)'; headerText.style.color = 'var(--iron-gold)'; msgBox.innerHTML = `<strong style="color:var(--iron-gold)">ATEN√á√ÉO:</strong> J√° se passaram ${diffDays} dias desde a sua √∫ltima sess√£o. Lembre-se, a consist√™ncia √© vital.`; } 
        else { alertBox.style.display = 'none'; }
    }

    function handleGPXUpload(input) { if (input.files.length > 0) { const reader = new FileReader(); reader.onload = function(e) { processGPX(e.target.result); }; reader.readAsText(input.files[0]); } }
    function processGPX(gpxContent) {
        const xmlDoc = new DOMParser().parseFromString(gpxContent, "text/xml"), trkpts = xmlDoc.getElementsByTagName("trkpt");
        if (trkpts.length < 2) { showToast("Ficheiro GPX inv√°lido.", "var(--iron-red)"); return; }
        let totalDistKm = 0;
        for (let i = 0; i < trkpts.length - 1; i++) totalDistKm += getDistanceFromLatLonInKm(parseFloat(trkpts[i].getAttribute("lat")), parseFloat(trkpts[i].getAttribute("lon")), parseFloat(trkpts[i+1].getAttribute("lat")), parseFloat(trkpts[i+1].getAttribute("lon")));
        const confirmDist = totalDistKm.toFixed(2);
        if(confirm(`Dist√¢ncia detetada: ${confirmDist} km.\nOnde deseja adicionar?\n1 = Nat, 2 = Bike, 3 = Corrida`)) {
             let sport = prompt("Digite 1, 2 ou 3", "3"); document.getElementById('in-swim').value = ""; document.getElementById('in-bike').value = ""; document.getElementById('in-run').value = "";
             if(sport === "1") document.getElementById('in-swim').value = (totalDistKm * 1000).toFixed(0); if(sport === "2") document.getElementById('in-bike').value = confirmDist; if(sport === "3") document.getElementById('in-run').value = confirmDist;
             showToast("Campos preenchidos! Salve o treino.", "var(--iron-blue)");
             const wrapper = document.getElementById('log-inputs-wrapper'); if (wrapper.classList.contains('collapsed')) { wrapper.classList.remove('collapsed'); document.getElementById('log-icon').classList.remove('collapsed'); }
        }
    }
    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; var dLat = (lat2-lat1)*(Math.PI/180); var dLon = (lon2-lon1)*(Math.PI/180); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function updateRPEText(val) {
        const labels = ["","Muito Leve","Leve","Leve","Moderado","Moderado","Forte","Forte","Muito Forte","Exaust√£o","M√°xima"], colors = ["","#0f8","#0f8","#0f8","#fc0","#fc0","#f60","#f60","#f33","#f00","#f00"];
        document.getElementById('rpe-text').innerText = `${labels[val]} (${val})`; document.getElementById('rpe-text').style.color = colors[val];
    }

    function addTraining() {
        const s = parseFloat(document.getElementById('in-swim').value)||0, st = parseFloat(document.getElementById('in-swim-time').value)||0;
        const b = parseFloat(document.getElementById('in-bike').value)||0, bt = parseFloat(document.getElementById('in-bike-time').value)||0;
        const r = parseFloat(document.getElementById('in-run').value)||0, rt = parseFloat(document.getElementById('in-run-time').value)||0;
        const rpe = document.getElementById('rpe-input').value;

        if(s===0 && b===0 && r===0) { showToast("Preencha ao menos uma dist√¢ncia.", "var(--iron-red)"); jarvisSpeak("Senhor, n√£o detetei nenhum movimento de treino."); return; }
        
        let logEntry = { date: new Date().toISOString(), text: [], rpe: rpe };
        if(s > 0) { let pace = (st>0)?` (${Math.floor(st/(s/100))}:${Math.round((st/(s/100)-Math.floor(st/(s/100)))*60).toString().padStart(2,'0')}/100m)`:""; logEntry.text.push(`üèä ${s}m${pace}`); }
        if(b > 0) { let pace = (bt>0)?` (${(b/(bt/60)).toFixed(1)} km/h)`:""; logEntry.text.push(`üö¥ ${b}km${pace}`); }
        if(r > 0) { let pace = (rt>0)?` (${Math.floor(rt/r)}:${Math.round((rt/r-Math.floor(rt/r))*60).toString().padStart(2,'0')}/km)`:""; logEntry.text.push(`üèÉ ${r}km${pace}`); }

        appState.logs.unshift(logEntry); if(appState.logs.length > 10) appState.logs.pop();
        appState.data.swim += s; appState.data.bike += b; appState.data.run += r; appState.totalAccumulated.swim += s; appState.totalAccumulated.bike += b; appState.totalAccumulated.run += r; appState.gear.shoes += r; appState.gear.chain += b;
        
        saveState(); updateUI(); updateGearUI(); if(document.getElementById('volumeModal').style.display === 'flex') updateVolumeUI();
        ['in-swim','in-swim-time','in-bike','in-bike-time','in-run','in-run-time','gpx-input'].forEach(id => document.getElementById(id).value = '');

        if(appState.gear.shoes >= 800) { jarvisSpeak("Treino registado, mas aten√ß√£o: integridade do seu cal√ßado comprometida."); showToast("‚ö† T√©nis excedeu o limite!", "var(--iron-red)"); } 
        else { jarvisSpeak("Treino atualizado com sucesso, senhor."); showToast("Sess√£o salva na base de dados.", "var(--iron-green)"); }
        const wrapper = document.getElementById('log-inputs-wrapper'); if (!wrapper.classList.contains('collapsed')) { wrapper.classList.add('collapsed'); document.getElementById('log-icon').classList.add('collapsed'); }
    }

    function openLogsModal() {
        const c = document.getElementById('logs-container');
        if(!appState.logs || appState.logs.length === 0) c.innerHTML = "<p style='color:#888; font-size:0.9rem;'>Nenhum registo recente.</p>";
        else {
            c.innerHTML = appState.logs.map(log => {
                const d = new Date(log.date), ds = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} √†s ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
                return `<div class="log-item"><div class="log-date"><span>${ds}</span><span>RPE: ${log.rpe}/10</span></div><div class="log-details">${log.text.join(' <span style="color:#666">|</span> ')}</div></div>`;
            }).join('');
        }
        openModal('logsModal');
    }

    function saveState() { localStorage.setItem('ironmanState', JSON.stringify(appState)); }
    
    function updateUI() {
        const p = phasesConfig[appState.phaseIndex]; document.getElementById('phase-badge').innerText = p.name.split(':')[0];
        const phaseProgressRatio = Math.min(Math.max(0, (new Date() - new Date(appState.phaseStartDate)) / (1000 * 60 * 60 * 24)) / 90, 1); 
        checkIdleAlert();

        ['swim','bike','run'].forEach(mode => {
            const val = appState.data[mode], goal = p.goals[mode], expected = goal * phaseProgressRatio;
            document.getElementById(`val-${mode}`).innerText = val; document.getElementById(`goal-${mode}`).innerText = goal;
            document.getElementById(`bar-${mode}`).style.width = Math.min((val/goal)*100, 100) + '%'; document.getElementById(`ghost-${mode}`).style.left = Math.min((expected/goal)*100, 100) + '%';
            const statusText = document.getElementById(`status-${mode}`);
            if (val >= expected) { document.getElementById(`bar-${mode}`).style.background = 'var(--iron-green)'; statusText.innerText = `‚ñ≤ +${Math.abs(val - expected).toFixed(0)} (Na meta)`; statusText.className = 'status-text status-positive'; } 
            else { document.getElementById(`bar-${mode}`).style.background = 'var(--iron-red)'; statusText.innerText = `‚ñº -${Math.abs(val - expected).toFixed(0)} (Atrasado)`; statusText.className = 'status-text status-negative'; }
        });
    }

    function saveHealthData() {
        appState.health.name = document.getElementById('health-name').value || "Rodrigo"; appState.health.sex = document.getElementById('health-sex').value;
        appState.health.weight = parseFloat(document.getElementById('health-weight').value) || appState.health.weight; appState.health.height = parseFloat(document.getElementById('health-height').value) || appState.health.height; appState.health.age = parseFloat(document.getElementById('health-age').value) || appState.health.age;
        let inputFat = parseFloat(document.getElementById('health-fat').value);
        if (!inputFat || isNaN(inputFat) || inputFat === 0) {
            const imc = appState.health.weight / Math.pow(appState.health.height/100, 2); appState.health.fat = parseFloat(Math.max((1.20 * imc) + (0.23 * appState.health.age) - (10.8 * (appState.health.sex === 'M' ? 1 : 0)) - 5.4, 3).toFixed(1)); 
        } else appState.health.fat = inputFat;
        saveState(); updateHealthUI(); closeModal('healthModal'); showToast("Biometria atualizada.", "var(--vital-main)");
    }

    function updateHealthUI() {
        document.getElementById('health-name').value = appState.health.name; document.getElementById('health-sex').value = appState.health.sex;
        document.getElementById('health-weight').value = appState.health.weight; document.getElementById('health-height').value = appState.health.height;
        document.getElementById('health-fat').value = appState.health.fat; document.getElementById('health-age').value = appState.health.age;
        document.getElementById('val-weight').innerText = appState.health.weight; document.getElementById('val-fat').innerText = appState.health.fat > 0 ? appState.health.fat : "--";
        document.getElementById('display-health-age').innerText = appState.health.age; document.getElementById('display-health-name').innerText = appState.health.name ? `Sinais Vitais: ${appState.health.name.split(' ')[0]}` : "Sinais Vitais";

        const root = document.documentElement;
        if(appState.health.sex === 'F') { root.style.setProperty('--vital-main', '#ff00ba'); root.style.setProperty('--vital-bg', 'rgba(255, 0, 186, 0.1)'); root.style.setProperty('--vital-shadow', 'rgba(255, 0, 186, 0.3)'); document.getElementById('health-icon').innerText = "ü©∑"; } 
        else { root.style.setProperty('--vital-main', '#00c3ff'); root.style.setProperty('--vital-bg', 'rgba(0, 195, 255, 0.1)'); root.style.setProperty('--vital-shadow', 'rgba(0, 195, 255, 0.3)'); document.getElementById('health-icon').innerText = "üîµ"; }

        const imc = (appState.health.weight / Math.pow(appState.health.height/100, 2)).toFixed(1), bmr = Math.round(appState.health.sex === 'F' ? 447.59 + (9.24 * appState.health.weight) + (3.09 * appState.health.height) - (4.33 * appState.health.age) : 88.36 + (13.4 * appState.health.weight) + (4.8 * appState.health.height) - (5.7 * appState.health.age));
        document.getElementById('calc-imc').innerText = imc; document.getElementById('calc-bmr').innerText = bmr + " kcal/dia";
        const statusEl = document.getElementById('display-bmi-status'); statusEl.innerText = `IMC ${imc} (${imc < 18.5 ? "Baixo Peso" : imc >= 30 ? "Obesidade" : imc >= 25 ? "Sobrepeso" : "Normal"})`;
        statusEl.style.color = (imc >= 25 || imc < 18.5) ? (imc >= 30 ? "var(--iron-red)" : "var(--iron-gold)") : "var(--iron-green)";
    }

    function setVolumeLevel(level) {
        currentVolumeLevel = level; document.querySelectorAll('.level-tab').forEach(el => el.classList.remove('active'));
        document.querySelector(`.level-tab.lvl-${level}`).classList.add('active'); updateVolumeUI();
    }
    function updateVolumeUI() {
        const target = annualTargets[currentVolumeLevel], totals = appState.totalAccumulated, badge = document.getElementById('lvl-badge');
        badge.innerHTML = `<h3 style="color:${target.color}">${target.name.toUpperCase()}</h3><p>${target.desc}</p>`; badge.style.borderLeft = `3px solid ${target.color}`;
        ['swim','bike','run'].forEach(t => renderGameBar(t, totals[t], target[t], target.color));
    }
    function renderGameBar(type, current, target, color) {
        const pct = Math.min((current / target) * 100, 100).toFixed(1);
        document.getElementById(`game-bar-${type}`).style.width = pct + '%'; document.getElementById(`game-bar-${type}`).style.backgroundColor = color;
        document.getElementById(`game-${type}-curr`).innerText = current.toLocaleString('pt-BR'); document.getElementById(`game-${type}-target`).innerText = target.toLocaleString('pt-BR'); document.getElementById(`game-${type}-pct`).innerText = pct >= 100 ? "üèÖ META ATINGIDA!" : `${pct}%`;
    }

    function factoryReset() { if(confirm("‚ö† AVISO CR√çTICO: Isto ir√° apagar todo o seu progresso.\nContinuar?")) { localStorage.removeItem('ironmanState'); location.reload(); } }
    
    function calculateNutrition() {
        const w = parseFloat(document.getElementById('nutri-weight').value), h = parseFloat(document.getElementById('nutri-hours').value);
        if(!w || !h) { showToast("Preencha os campos para o c√°lculo.", "var(--iron-red)"); return; }
        const totalCarbs = Math.round(60 * h); document.getElementById('nutri-result').style.display = 'block'; document.getElementById('nutri-grams').innerText = totalCarbs + "g Carbo";
        document.getElementById('nutri-breakdown').innerHTML = `<li>~ ${Math.floor(totalCarbs / 22)} G√©is</li><li>~ ${Math.round((totalCarbs % 22) / 30)} Garrafas Iso</li><li>Ou ${Math.round(totalCarbs/25)} Bananinhas</li>`;
    }

    function setCompareMode(mode) { currentCompareMode = mode; document.getElementById('btn-703').className = mode === '70.3' ? 'toggle-btn active' : 'toggle-btn'; document.getElementById('btn-full').className = mode === 'Full' ? 'toggle-btn active' : 'toggle-btn'; renderTips(); }
    function comparePerformance() {
        let tSwim = currentCompareMode === 'Full' ? 95 : 90, tBike = currentCompareMode === 'Full' ? 36 : 40, tRun = currentCompareMode === 'Full' ? 270 : 225;
        const uSwim = (parseFloat(document.getElementById('comp-swim-min').value)||0)*60 + (parseFloat(document.getElementById('comp-swim-sec').value)||0), uBike = parseFloat(document.getElementById('comp-bike-kmh').value)||0, uRun = (parseFloat(document.getElementById('comp-run-min').value)||0)*60 + (parseFloat(document.getElementById('comp-run-sec').value)||0);
        if(uSwim>0) updatePctText('pct-swim', (tSwim/uSwim)*100, 'comp-bar-swim'); if(uBike>0) updatePctText('pct-bike', (uBike/tBike)*100, 'comp-bar-bike'); if(uRun>0) updatePctText('pct-run', (tRun/uRun)*100, 'comp-bar-run');
    }
    function updatePctText(id, val, barId) {
        document.getElementById(id).innerText = val.toFixed(0) + "%"; document.getElementById(id).style.color = val >= 100 ? "var(--iron-green)" : (val >= 80 ? "var(--iron-gold)" : "var(--iron-red)"); document.getElementById(barId).style.width = Math.min(val, 100) + '%';
    }
    function renderTips() {
        document.getElementById('tip-swim').innerHTML = `<h4>üí° Fato</h4><p>T√©cnica > For√ßa. Alvo Top 100: Pace 1:20-1:35/100m.</p>`; document.getElementById('tip-bike').innerHTML = `<h4>üí° Fato</h4><p>Alvo Top 100: M√©dia 38-42km/h.</p>`; document.getElementById('tip-run').innerHTML = `<h4>üí° Fato</h4><p>Alvo Top 100: Meia maratona entre 1h15 e 1h25.</p>`;
    }

    function updateGearUI() {
        const sPct = Math.min((appState.gear.shoes/800)*100, 100), cPct = Math.min((appState.gear.chain/5000)*100, 100);
        document.getElementById('gear-shoes-val').innerText = appState.gear.shoes.toFixed(1)+" km"; document.getElementById('bar-shoes').style.width = sPct + '%'; document.getElementById('alert-shoes').style.display = sPct>=100 ? 'block':'none';
        document.getElementById('gear-chain-val').innerText = appState.gear.chain.toFixed(1)+" km"; document.getElementById('bar-chain').style.width = cPct + '%';
    }
    function resetGear(t) { if(confirm("Deseja repor a zero?")) { appState.gear[t]=0; saveState(); updateGearUI(); showToast("Equipamento renovado.", "var(--iron-blue)"); } }
    function exportData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appState)); a.download = "jarvis-backup.json"; a.click(); showToast("Backup gerado.", "var(--iron-green)"); }
    function importData(i) { const r = new FileReader(); r.onload = e => { if(confirm("Sobrescrever?")) { appState=JSON.parse(e.target.result); saveState(); init(); showToast("Restaurado.", "var(--iron-purple)"); closeModal('settingsModal'); } }; if(i.files[0]) r.readAsText(i.files[0]); }

    function openModal(id) {
        if(id==='planModal') { const p = phasesConfig[appState.phaseIndex]; document.getElementById('plan-phase-name').innerText = p.name; document.getElementById('plan-objective').innerText = p.plan.obj; document.getElementById('plan-container').innerHTML = `<div class="plan-item"><h4>üèä Nata√ß√£o</h4><p>${p.plan.swim}</p></div><div class="plan-item"><h4>üö¥ Ciclismo</h4><p>${p.plan.bike}</p></div><div class="plan-item"><h4>üèÉ Corrida</h4><p>${p.plan.run}</p></div><div class="plan-item full-width"><h4>üèãÔ∏è For√ßa</h4><p>${p.plan.gym}</p></div>`; } 
        else if (id === 'volumeModal') updateVolumeUI(); else if (id === 'healthModal') updateHealthUI(); document.getElementById(id).style.display='flex';
    }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    
    function saveRaceDate() { appState.raceDate=document.getElementById('race-date-input').value; saveState(); startCountdown(); showToast("Data alvo atualizada.", "var(--iron-blue)"); }
    
    // --- CONTADOR ORIGINAL COM A CLASSE DAS CHAMAS DIN√ÇMICAS ---
    function startCountdown() {
        if(!appState.raceDate) return;
        const d = Math.floor((new Date(appState.raceDate)-new Date())/(1000*60*60*24));
        
        let c1, c2, c3, msgColor, msg;

        if (d < 0) {
            c1 = "#e0b0ff"; c2 = "#9d00ff"; c3 = "#4b0082"; // Roxo/Neon
            msgColor = "var(--iron-purple)";
            msg = "O GRANDE DIA";
        } else if (d <= 30) {
            c1 = "#ffea00"; c2 = "#ff8000"; c3 = "#f00"; // Vermelho/Laranja (Fogo cl√°ssico - Cr√≠tico)
            msgColor = "var(--iron-red)";
            msg = "F√öRIA FINAL";
        } else if (d <= 90) {
            c1 = "#fffb00"; c2 = "#ffb300"; c3 = "#ff6600"; // Dourado/Amarelo
            msgColor = "var(--iron-gold)";
            msg = "DIAS PARA O √çMPETO GLORIOSO";
        } else if (d <= 180) {
            c1 = "#aeff00"; c2 = "#00ff88"; c3 = "#009933"; // Verde
            msgColor = "var(--iron-green)";
            msg = "DIAS AVANTES PARA GL√ìRIA";
        } else {
            c1 = "#00ffff"; c2 = "#00c3ff"; c3 = "#0044ff"; // Azul (Frio/Seguro)
            msgColor = "var(--iron-blue)";
            msg = "DIAS PARA A GL√ìRIA";
        }

        document.getElementById('countdown-display').innerHTML = `
            <span class="fire-numbers" style="--fire-c1:${c1}; --fire-c2:${c2}; --fire-c3:${c3};">${Math.max(0, d)}</span> 
            <span style="font-size:0.95rem; color:${msgColor}; align-self:center; font-weight:bold; letter-spacing:1px; margin-top:5px; margin-left: 10px;">${msg}</span>
        `;
    }

    function generateReport() {
        openModal('reportModal'); const p = phasesConfig[appState.phaseIndex];
        document.getElementById('report-body').innerHTML = ['swim','bike','run'].map(k=>`<tr><td>${k.toUpperCase()}</td><td>${appState.data[k]}</td><td>${((appState.data[k]/p.goals[k])*100).toFixed(0)}%</td></tr>`).join('');
        const pass = (appState.data.swim/p.goals.swim + appState.data.bike/p.goals.bike + appState.data.run/p.goals.run)/3 >= 0.8;
        document.getElementById('verdict-display').innerText = pass ? "APROVADO ‚úÖ" : "PENDENTE ‚è≥"; document.getElementById('btn-advance').style.display = pass ? "block" : "none";
    }
    function advancePhase() { 
        if(appState.phaseIndex<3) { appState.phaseIndex++; appState.data={swim:0,bike:0,run:0}; appState.phaseStartDate = new Date().toISOString(); saveState(); init(); closeModal('reportModal'); jarvisSpeak("Parab√©ns, senhor. Avan√ßamos para a pr√≥xima fase."); showToast("Nova Fase libertada!", "var(--iron-gold)"); } 
        else { jarvisSpeak("O senhor concluiu o plano. Vemo-nos na meta."); showToast("Plano conclu√≠do!", "var(--iron-purple)"); }
    }
    function simulateTimeTravel(days) {
        let s = new Date(appState.phaseStartDate); s.setDate(s.getDate() - days); appState.phaseStartDate = s.toISOString();
        if(appState.logs.length > 0) { let l = new Date(appState.logs[0].date); l.setDate(l.getDate() - days); appState.logs[0].date = l.toISOString(); }
        saveState(); updateUI(); jarvisSpeak(`Salto temporal conclu√≠do, senhor. Avan√ß√°mos ${days} dias.`); showToast(`‚è±Ô∏è +${days} dias simulados.`, "var(--iron-purple)");
    }
    function resetTimeTravel() { appState.phaseStartDate = new Date().toISOString(); if(appState.logs.length > 0) appState.logs[0].date = new Date().toISOString(); saveState(); updateUI(); jarvisSpeak("Tempo restaurado."); showToast("‚è±Ô∏è Tempo restaurado.", "var(--iron-gray)"); }

    init();
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>